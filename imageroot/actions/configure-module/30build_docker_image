#!/bin/bash

set -e
source erpnext-modules.env
# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_info() {
	echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
	echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
	echo -e "${RED}[ERROR]${NC} $1"
}

# Check if podman is installed
if ! command -v podman &>/dev/null; then
	print_error "podman is required but not installed. Please install podman first."
	exit 1
fi

# Check if jq is installed
if ! command -v jq &>/dev/null; then
	print_error "jq is required but not installed. Please install jq first."
	exit 1
fi

# Check if ERPNEXT_IMAGE is set
if [ -z "$ERPNEXT_IMAGE" ]; then
	print_error "ERPNEXT_IMAGE environment variable is not set"
	print_info "Please set it in .env file or export it:"
	echo "  export ERPNEXT_IMAGE=docker.io/geniusdynamics/erpnext:15.92.1"
	exit 1
fi

# Extract image name and tag from ERPNEXT_IMAGE
BASE_IMAGE="$ERPNEXT_IMAGE"
# Extract repository and tag
IMAGE_REPO=$(echo "$ERPNEXT_IMAGE" | cut -d':' -f1)
IMAGE_TAG=$(echo "$ERPNEXT_IMAGE" | cut -d':' -f2)

# Use the same tag for custom image
CUSTOM_IMAGE_NAME="${IMAGE_REPO}"
CUSTOM_IMAGE_TAG="$IMAGE_TAG"

print_info "Base Image: $BASE_IMAGE"
print_info "Custom Image will be: $CUSTOM_IMAGE_NAME:$CUSTOM_IMAGE_TAG"

print_info "Modules from environment: $ERP_NEXT_MODULES"

print_info "Apps to be installed:"
echo "$APPS_JSON"

FRAPPE_BRANCH="version-15"

print_info "Using Frappe branch: $FRAPPE_BRANCH"
print_info "Building custom ERPNext image with Podman..."

# Build the image with Podman
podman build --network=host \
	--build-arg BASE_IMAGE="$BASE_IMAGE" \
	--build-arg APPS_JSON_BASE64="$APPS_JSON" \
	--build-arg FRAPPE_BRANCH="$FRAPPE_BRANCH" \
	-t "$CUSTOM_IMAGE_NAME:$CUSTOM_IMAGE_TAG" \
	-f ../actions/configure-module/Dockerfile \
	.

if [ $? -eq 0 ]; then
	print_info "Build completed successfully!"
	print_info "Image tagged as: $CUSTOM_IMAGE_NAME:$CUSTOM_IMAGE_TAG"

	# Also tag as latest
	podman tag "$CUSTOM_IMAGE_NAME:$CUSTOM_IMAGE_TAG"

	# Tag with the same name as base image (for drop-in replacement)
	podman tag "$CUSTOM_IMAGE_NAME:$CUSTOM_IMAGE_TAG" "$BASE_IMAGE"
	print_info "Also tagged as: $BASE_IMAGE (drop-in replacement)"

	echo ""
	print_info "To push the image to a registry:"
	echo "  podman push $CUSTOM_IMAGE_NAME:$CUSTOM_IMAGE_TAG"
	echo "  podman push $CUSTOM_IMAGE_NAME:latest"
	echo "  podman push $BASE_IMAGE"

	echo ""
	print_info "Image size:"
	podman images "$CUSTOM_IMAGE_NAME:$CUSTOM_IMAGE_TAG" --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"

	echo ""
	print_info "To use this image, it's already tagged as: $BASE_IMAGE"
	print_info "Your existing docker-compose or deployment will automatically use the custom image!"
else
	print_error "Build failed!"
	exit 1
fi
